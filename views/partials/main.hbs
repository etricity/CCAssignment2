<!doctype html>

<!--Main document for the Page. Other handlebar files are passed to this for dynamic html-->

<html lang="en">

<head>
  <meta charset="UTF-8">
  <title></title>
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<nav>
  <div class='full-content'>
    <p> S.P.A.D.E</p>
  </div>
  <div class='bottom-content'>
    <a id="webplayer">Spotify Web Player</a>
    <a href="https://www.spotify.com/au/"> Go To Spotify</a>
  </div>
</nav>

<body>
  <!--    Handlebar stuff-->
  <div id='title'>
    <h1 id='greeting'></h1>
  </div>

  <div id='table-div'>
    <table id='user-Table'>
      <tr>
        <td>Name </td>
        <td id='name'></td>
      </tr>
      <tr>
        <td>Country</td>
        <td id='country'></td>
      </tr>
      <tr>
        <td>Email</td>
        <td id='email'></td>
      </tr>
      <tr>
        <td>Product</td>
        <td id='product'></td>
      </tr>
    </table>
  </div>

  <div id='song-div'>
    <table id='song-Table'>
      <tr>
        <td>Song Name </td>
        <td id='result-name'></td>
      </tr>
      <tr>
        <td>Artist</td>
        <td id='artist'></td>
      </tr>
      <tr>
        <td>Album</td>
        <td id='album'></td>
      </tr>
      <tr>
        <td>Relative Popularity Rating</td>
        <td id='popularity'></td>
      </tr>
    </table>
  </div>




  <div class="full-content">
    <form id='form'>
      <p>Search For A Song</p>
      <input id='song-name' type="text" />
      <button type=submit> Search</button>
      <p id='song-data'></p>
    </form>

  </div>




  <footer> S.P.A.D.E &COPY; </footer>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

  <script>
    var params = getHashParams();
    var access_token = params.access_token,
      refresh_token = params.refresh_token;

    //Utility Function
    function getHashParams() {
      var hashParams = {};
      var e, r = /([^&;=]+)=?([^&;]*)/g,
        q = window.location.hash.substring(1);
      while (e = r.exec(q)) {
        hashParams[e[1]] = decodeURIComponent(e[2]);
      }
      return hashParams;
    }

    //Onload
    window.onload = () => {

      $.ajax({
        url: 'https://api.spotify.com/v1/me',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        success: function(response) {
          console.log(response);
          paintPage(response);
        }
      });

      var codes = window.location.hash.substr(1);
      var link = "/spotify/webplayer/#" + codes;
      document.getElementById("webplayer").setAttribute("href", link);
    }


    function paintPage(response) {
      document.getElementById("greeting").innerText = response.display_name;
      document.getElementById("name").innerText = response.display_name;
      document.getElementById("email").innerText = response.email;
      document.getElementById("country").innerText = response.country;
      document.getElementById("product").innerText = response.product;



    }
  </script>
  <script>
    $('document').ready(function() {
      //When form is submited
      $('#form').on('submit', function(ev) {
        //Stop default post call
        ev.preventDefault();

        //Variable for API call data
        var data;

        //Request to server
        //Client --> Server --> Spotify --> Server --> Client
        $.ajax({
          url: '/spotify/search',
          headers: {
            'Authorization': 'Bearer ' + access_token
          },
          data: {
            song_name: document.getElementById("song-name").value,
            access_token: access_token
          },
          success: success,
          error: error
        });

        //This is were you should populate the HTML with info
        function success(data) {
          console.log(data);
          paintSongData(data);
        }

        function error(error) {}

      });
    });

    function paintSongData(data) {
      document.getElementById("song-data").innerText = 'This song was created by ' + data.tracks.items[0].artists[0].name;
      document.getElementById("result-name").innerText = data.tracks.items[0].name;
      document.getElementById("artist").innerText = data.tracks.items[0].artists[0].name;
      document.getElementById("album").innerText = data.tracks.items[0].album.name;
      document.getElementById("popularity").innerText = data.tracks.items[0].popularity;
      document.getElementById("song-div").style.visibility = "visible";
    }
  </script>


</body>

</html>
